# 版本管理 Git 使用技术报告
## 目录
- 一、引言
- 二、Git简介
- 1.Git版本管理系统的功能
- 2.Git特点
- 3.Git的工作机制
- 4.四个协议
- 三、了解Git
- 1.Git的基本概念
- 2.Git的常见命令
- 3.Git的工作流程
- 四、Git的使用
- 1.安装 Git 和配置 Git 环境(windows版本）
- 2.获取帮助
- 3.Git的分支管理
- 4.Git的远程仓库管理
- 5.Git服务器搭建与操作
- 6.Git日志与操作
- 7.Git 的逆向操作
- 8.本地仓库整理操作
- 五、结论

### 一、引言
随着软件开发规模的不断扩大和团队协作的复杂性增加，版本控制已经成为现代软件开发中不可或缺的一部分。版本控制系统（Version Control System, VCS）提供了一种高效的方式来跟踪和管理代码的修改历史，保证团队在协作时不会丢失任何重要的变更，并且能够有效地进行错误回溯和功能迭代。Git作为一种分布式版本控制系统，以其高效的分支管理和灵活的协作方式，已成为当前最广泛使用的版本控制工具之一。本报告将重点介绍版本管理的基础知识，Git的核心特性与工作原理，以及Git在开源项目中的应用。

### 二、Git简介
Git是一个开源的分布式版本控制系统，由Linus Torvalds于2005年开发，主要用于高效管理代码及其历史版本。与传统的集中式版本控制系统（如SVN）不同，Git在每个开发者的本地都维护着完整的代码库副本，允许开发者离线工作，并通过合并操作实现分布式协作。

### 1.Git版本管理系统的功能
版本管理系统用于记录文件的变更历史，在多人的协作开发中尤为重要。它不仅帮助开发者追踪代码的历史演变，还允许开发人员在出现问题时回溯到历史版本。以下是Git版本管理系统的主要功能
- **记录文件的修改历史**：版本控制系统可以追踪文件的每一次修改，并记录下修改的时间、作者和描述等信息。这样可以很方便地查看文件的历史变更，包括添加、删除和修改等操作。
- **回溯到特定版本**：通过版本控制系统，开发人员可以在任何时间点回到特定的版本，以查看、比较或还原文件的状态。这对于修复bug、追溯问题或回退错误的修改非常有帮助。
- **并行开发与协同合作**：版本控制系统允许多个开发人员同时修改同一个文件，而不会互相影响。开发人员可以基于同一个版本创建并行的分支，在分支上进行独立开发，并在需要时将修改合并到主分支中。
- **保护代码的完整性**：版本控制系统通过对每个版本的文件进行存储和验证，可以保证代码的完整性和可靠性。即使出现文件损坏、删除或丢失等情况，也可以通过版本控制系统来恢复和还原文件。

#### 2.Git特点
- **分布式架构**：Git的每个开发人员都拥有完整的代码仓库，包括所有的历史记录和分支信息。即使在没有网络连接的情况下，也可以进行大部分操作。这使得团队成员可以在本地独立开发，不依赖于服务器的可用性。
- **高效的性能**：Git使用快照（Snapshot）而不是差异（Delta）来存储文件变化。这种存储方式非常高效，能够快速进行提交、分支、合并和查找操作，特别是在大型项目中表现优异。
- **强大的分支管理**：Git的分支操作非常轻量且高效。开发人员可以轻松创建、切换和合并分支，适合并行开发和不同功能的实验，支持灵活的分支管理。
- **完整的历史记录**：每次提交都包括详细的信息（如提交者、时间戳、提交说明等），这使得开发人员可以方便地回溯到特定的版本，并追溯代码的变更历史。
- **数据完整性和安全性**：Git使用SHA-1哈希算法确保代码库的完整性和安全性。每次提交的文件和历史记录都受到保护，防止篡改或丢失。
- **与其他工具的集成**：Git可以与常用的开发工具（如IDE、代码托管平台和持续集成工具）进行集成，方便开发人员与团队合作和管理代码。

总的来说，Git是一种强大、高效和灵活的版本控制系统，被广泛应用于软件开发领域。无论是个人项目还是大型团队，使用Git可以提供更好的代码管理和协同工作体验。

#### 3.Git的工作机制
Git的工作机制围绕四个主要区域展开：工作区（Working Directory）、暂存区（Staging Area）、版本库（Repository）、和远程仓库（Remote）。

- **工作区**：这是开发者进行代码编辑和修改的地方，包含了项目的实际文件。
- **暂存区**：在修改文件后，开发者使用git add命令将文件从工作区添加到暂存区，准备提交。
- **版本库**：每次使用git commit命令提交时，暂存区的文件会被记录到版本库，成为一个新的版本。
- **远程仓库**：远程仓库，托管代码的服务器，可以简单的认为是你项目组中的一台电脑用于远程数据交换。
这一机制的优势在于，开发者可以根据需求选择性地将修改添加到暂存区，确保提交的准确性。此外，Git还支持强大的分支管理，允许开发人员在多个分支上并行开发，然后再将其合并到主分支中。

### Git 的工作流程：
在工作区目录中添加、修改文件；产生数据变更。
将需要进行版本管理的文件add到暂存区域；
将暂存区域的文件commit到git仓库；
本地的修改push到远程仓库，如果失败则执行第5步；
git pull将远程仓库的修改拉取到本地，如果有冲突需要修改冲突，回到第三步。

git管理的文件至少有三种状态：已修改（modified）、已暂存（staged）、已提交(committed)。

开发者在工作区修改文件，然后把工作区修改的文件暂存到暂存区，再使用git commit命令将暂存区的内容提交到本地仓库，git commit命令一般要加-m参数告诉 Git 当前是提交的什么内容；最后通过git push origin master命令推送到远端仓库。

可以使用git status查看工作区的文件状态。文件主要有四种状态：

- **Untracked**：未追踪的文件，此文件在文件夹中，但并没有加入到git库，不参与版本控制。即Git还没有管理的文件。要想让文件变成被 Git 管理，需要将文件添加到暂存区，即使用git add命令将状态变为Staged。
- **Unmodify**：文件已经入库且未修改, 即版本库中的文件快照内容与文件夹中完全一致，这种类型的文件有两种去处，如果它被修改， 而变为Modified，如果使用git rm移出版本库, 则成为Untracked文件。
- **Modified**：文件已修改，仅仅是修改，并没有进行其他的操作，这个文件也有两个去处，通过git add可进入暂存staged状态，使用git checkout 则丢弃修改，返回到unmodify状态, 这个git checkout即从库中取出文件，覆盖当前修改。
- **Staged**：暂存状态，执行git commit则将修改同步到库中，这时库中的文件和本地文件又变为一致，文件为Unmodify状态。


### 4.四个协议
本地与远端交互的时候，需要遵循相同的协议。有四个协议可以用于交互：
- **HTTP**：使用HTTP协议进行Git操作时，由于其开放性与广泛支持，使得Git可以直接通过网页浏览器或简单的HTTP客户端进行访问。HTTP的广泛可用性意味着可以使用各种在线工具或服务器来进行Git操作，但同时也意味着可能需要额外的服务器配置来处理身份验证、SSL安全以及可能的防火墙限制。
- **HTTPS**：HTTPS是HTTP的加密版本，使用SSL/TLS协议来加密数据传输，确保了数据在从本地到远程仓库或从远程仓库到本地的传输过程中不被第三方截取或篡改。HTTPS提供了更高的安全性，是如今Web服务中数据传输的首选方式。在Git中使用HTTPS时，通常需要一个公钥和私钥对，公钥用于服务器验证，私钥则用于客户端身份验证和加密数据。
- **SSH（Secure Shell）**：SSH协议主要用于在两个计算机之间提供网络安全的通信。在Git中，SSH被用来安全地进行代码的远程传输，尤其适用于需要通过SSH密钥进行身份验证的情况，这种验证方式更加安全且无需输入用户名和密码。SSH协议通过端口22进行通信，提供了在用户认证、文件传输、远程命令执行等多个方面上的安全连接。
- **Git**：这是Git本身提供的协议，主要用于在Git仓库间进行快照和差异的存储和传输。Git协议是专为版本控制而设计的，它使用一种称为“轻量级的传输协议”（LWTP），能够有效地进行快照存储、分支和合并等功能。相比于HTTP和HTTPS，Git协议在进行版本控制时更加高效和直接，能够更好地处理分支和合并等特性，而无需通过外部协议进行数据传输。

本地仓库和远端仓库交互的时候是基于TCP进行数据交互的，那么就需要一个上层协议来完成，比较常用的是SSH协议。使用SSH协议的原因是因为通用的服务器默认都安装有SSH服务器。


### 三、了解Git
### 1.Git的基本概念
**仓库（Repository）**  
   仓库就是可以用git管理的一个目录，这个仓库里所有的文件的改动（增加 / 修改 / 删除）都由git跟踪记录。也能通过git查看所有的记录，当然也能够通过git“还原”到某个记录点。Git仓库可以是本地仓库，也可以是远程仓库。
**工作目录（Working Directory）**  
   工作目录是开发者正在编辑的代码文件所在的地方。在此目录下，开发者可以进行文件修改。
**暂存区（Staging Area）**  
   暂存区是Git的一个中介区，介于工作目录和仓库之间。开发者修改的文件可以通过git add命令加入暂存区，准备提交到仓库。
**提交（Commit）**  
   提交是Git中的基本操作，它将暂存区的文件记录到仓库中，形成一个新的版本。
**分支（Branch）**  
   分支是Git中并行开发的核心。每个分支都包含着独立的历史记录，允许开发者在不干扰主分支的情况下进行功能开发。
**合并（Merge）**  
   合并是将两个分支的代码合并成一个分支的操作。Git通过三方合并算法实现代码的智能合并。

### 2.Git的常见命令
以下是Git常用的操作命令，开发者可以通过这些命令进行日常开发工作：
- `git init`：初始化一个Git仓库
- `git clone <repository-url>`：克隆远程仓库到本地
- `git add <file>`：将文件添加到暂存区
- `git commit -m "message"`：提交修改到本地仓库
- `git pull`：从远程仓库拉取最新的修改
- `git push`：将本地修改推送到远程仓库
- `git branch`：查看分支信息或创建新分支
- `git merge <branch>`：合并指定的分支到当前分支
- `git status`：查看当前工作区和暂存区的状态，显示哪些文件被修改、哪些文件已暂存等。
- `git diff`：查看文件的差异，能够显示工作目录与暂存区之间的差异。
- `git reset`：用于撤销某些操作，可以将提交回退到某一历史版本。
- `git rebase`：用于将一个分支的修改移到另一个分支的基础上，相较于合并，rebase的历史记录更为简洁。

### 3.Git的工作流程
Git的工作流程通常遵循以下步骤：
创建仓库（`git init`）
克隆仓库（`git clone`）
文件修改与暂存（`git add`）
提交修改（`git commit`）
推送修改（`git push`）
拉取更新（`git pull`）
查看版本历史（`git log`）
分支管理（`git branch` 和 `git checkout`）



### 四、Git的使用
### 1.安装 Git 和配置 Git 环境(windows版本）
在Windows上安装Git可以在Git官方网站下载，我的电脑是64位操作系统，下载对应的安装包。
或者另一个简单的方法是安装GitHub for Windows。该安装程序包含图形化和命令行版本的Git。它也能支持Powershell，提供了稳定的凭证缓存和健全的换行设置。

安装完Git应该做的第一件事就是设置你的用户名称与邮件地址。每一个 Git的提交都会使用这些信息，并且它会写入到你的每一次提交中，不可更改：
```bash
git config --global user.name "LionLong"
git config --global user.email ntf_work@163.com
```
如果使用了--global选项，那么该命令只需要运行一次，因为之后无论你在该系统上做任何事情，Git都会使用那些信息。如果想针对特定项目使用不同的用户名称与邮件地址时，可以在那个项目目录下运行没有--global选项的命令来配置。
很多GUI工具都会在第一次运行时配置这些信息。也可以使用git config --list来查看git的所有配置。

### 2.获取帮助
若使用 Git 时需要获取帮助，有三种方法可以找到Git命令的使用手册：
```bash
git help <verb>
git <verb> --help
man git-<verb>
```
例如，要想获得 config 命令的手册，执行：
```bash
git help config
```

### 3.Git的分支管理
**分支的创建与切换**  
   在Git中，分支可以独立开发功能或修复bug，避免了直接在主分支上的修改。使用 `git branch <branch-name>` 创建分支，使用 `git checkout <branch-name>` 切换分支。
**合并分支**  
   当一个分支上的开发完成后，可以使用 `git merge <branch-name>` 将其合并到当前分支。
**解决冲突**  
   在合并分支时，如果同一文件的同一部分被不同分支修改，Git会提示冲突。开发者需要手动解决冲突，选择合适的代码进行合并。

### 4.Git的远程仓库管理
Git支持与持续集成工具（如Jenkins、Travis CI）进行集成，通过在Git仓库配置Webhooks，当代码提交发生变化时，持续集成工具可以自动触发构建、测试和部署操作。这样可以确保代码的质量，并自动化部署流程，提高开发效率。
**远程仓库的添加与查看**  
   使用 `git remote add <name> <url>` 添加远程仓库，使用 `git remote -v` 查看远程仓库的URL。
**推送与拉取**  
   使用 `git push <remote> <branch>` 将本地分支推送到远程仓库，使用 `git pull <remote> <branch>` 拉取远程分支。

### 如何使用SSH协议进行本地仓库和远端仓库的交互
使用SSH协议可以实现安全的本地仓库与远端仓库之间的交互。SSH密钥对（公钥和私钥）是实现这一安全验证的核心。通常，您需要将公钥放置到远端仓库服务器，而使用私钥进行验证。这样可以确保交互过程中的安全性和可靠性。

#### 生成SSH密钥对
可以通过以下命令生成SSH公钥和私钥：
```bash
ssh-keygen -t rsa
```
按回车键接受默认设置。
### SSH密钥的默认存储位置
生成的密钥对默认存储在用户的家目录下：
```bash
Windows：C:\Users\用户名\.ssh\
```
其中，公钥为id_rsa.pub，私钥为id_rsa。需要将公钥（id_rsa.pub）的内容复制到远端服务器中。
### 配置远端服务器以接受公钥
在远端服务器的/home/用户名/.ssh/目录下，找到（或创建）authorized_keys文件，并将公钥的内容粘贴到该文件中保存。完成后，本地仓库即可通过SSH免密登录远端仓库进行交互。
### 使用SSH协议拉取代码
通过SSH协议拉取远端仓库的代码到本地时，使用git clone命令，并指定SSH协议和远端仓库的信息。示例如下：
```bash
git clone ssh://fly@192.168.31.91:/home/fly/srcs
```
这将会在当前目录生成一个名为srcs的文件夹，并在该文件夹中创建一个.git文件夹，表示本地仓库。
### 配置本地仓库的用户名和邮箱
为了在提交代码时记录提交者的信息，需要设置本地仓库的用户名和邮箱。这可以通过以下命令进行配置：
全局设置（适用于所有仓库）：
```bash
git config --global user.name "LionLong"
git config --global user.email "ntf_work@163.com"
```
局部设置（仅适用于当前仓库）：
```bash
git config user.name "LionLong"
git config user.email "ntf_work@163.com"
```
如果没有使用--global参数，设置仅在当前目录下有效，配置文件通常保存在.git/config文件中。



### 5.Git服务器搭建与操作
虽然git是一个分布式的版本管理工具，但如果有中央服务器会对多人协作产生很大的帮助。
### 创建git的中央服务器
创建git账号和git用户组。
```bash
$ sudo adduser git  #添加git用户
$ sudo passwd git   #添加git的密码
$ sudo groupadd git #添加git用户组
$ sudo usermod -G git git #添加git用户到git用户组
```
### 创建git仓库。
```bash
$ cd /srv            # srv目录下存放git的仓库
$ mkdir src-docs.git # 创建src-docs.git目录
$ cd src-docs.git
$ git init --bare    # bare选项指示该仓库为裸仓库
$ sudo chown -R git:git /srv/src-docs.git # 修改权限为git用户
```
### 禁止git用户登录shell
这样git通过sh服务登录会被拒绝。
```bash
chsh git
```
### 克隆远程仓库
clone命令为：git clone git@<您的 CVM IP 地址>:git仓库路径。在这个过程中需要输入用户名和密码。

例如，打开git bash shell，输入：
```bash
git clone git@192.106.79.26:/srv/src-docs.git
```

### 免密输入的配置
就是通过rsa认证，生成公钥和私钥，然后把客户端的公钥告诉git服务器。
在客户端机器上已经配置用户名和密码，然后打开git bash shell，生成rsa的秘钥对。

在git服务器上的仓库路径执行ssh-keygen –t rsa和touch authorized_keys，然后把客户端的id_rsa.pub追加到这个文件里。这样后，我们就不需要每次都输入git密码了。



### 6.Git日志与操作
可以使用git log命令查看提交日志，例如：
```bash
$ git log
commit 4b16e0b15c412e977d95a122f4b16e0b15c412e9 (HEAD -> master, origin/master)
Author: 
Date:   
    feat:add func
```
可以注意到，有一个40位的hash值4b16e0b15c412e977d95a122f4b16e0b15c412e9 （hash值是通过sha1函数来生成的），这个值就是当次提交生成的唯一标识ID，这个唯一标识ID也称为版本号。通常可以通过这个版本号查到是哪一次提交。

除了40位的hash值，还有一个HEAD也是需要注意的，HEAD是当前检出记录的符号引用，可以理解为一个指针，也可以理解为一个引用。因为是协作开发，所以通常会有一个很长的提交记录（即提交序列或列表），HEAD就是一个指向最近一次提交的指针。上述例子中HEAD指向master，同时和origin/master是在相同位置。如果我们需要获取任何一个版本的信息，就可以以HEAD作为基本依据，往前推几个版本。


### 7.Git 的逆向操作

正向操作的话Git 操作是由 workspace进行add操作进入Index，再commit到Repository，最后push到Remote。

但有如果数据文件已经由 workspace进行add操作进入Index了，但是发现本次提交的数据有些问题，想把它撤回来，即撤到workspace中；或者数据文件已经commit到Repository了，但是，我们想把数据回退，将其回退到Index或 workspace，甚至删除提交记录等。这就需要逆向操作。

**暂存区到工作空间**：如果数据已经由工作空间（workspace）提交（add）到暂存区（Index）后需回退，可以使用git restore -S命令。

git restore -S 的用途：

恢复文件状态：可以将文件恢复到某个特定的提交（commit）状态。
签名验证: 使用 -S 选项可以确保恢复的内容经过签名验证，符合安全标准。
使用示例：假设有一个文件 example.cc，可以使用以下命令将其恢复到指定的提交状态（例如 abc123）。
```bash
git restore -S example.cc
```
这样，原本在暂存区的example.cc数据将回退到Untracked files状态


**本地仓库到暂存区、工作区及清空**：如果数据从暂存区（Index）提交（commit）到本地仓库（Repository）后需回退，可以使用 git reset --soft、git reset --mixed 和 git reset --hard，这三者区别在于对工作区、暂存区和提交历史影响程度不同。

git reset --soft 主要用于回退到暂存区，仅影响 HEAD 位置，不改变工作区和暂存区内容，适合修改最近提交历史且不丢失当前工作区和暂存区变更的情况。

git reset --mixed（git reset 命令默认参数）则主要回退到工作区（workspace），会影响 HEAD 位置和暂存区，不改变工作区内容，可将 HEAD 移动到指定提交，同时将之后的修改放入暂存区，适用于需撤销提交但保留更改以便后续重新提交的情况。

git reset --hard 会完全取消提交及相关更改，影响 HEAD、暂存区和工作区，将 HEAD 指向指定提交，同时重置暂存区和工作区到该提交，丢弃所有未提交更改，适合完全撤销到某个提交且不关心之前修改的情况。

其语法为 
```bash
git reset <--soft or --mixed or --hard> <commit or HEAD>。
```

**工作区清空**：要清空工作区数据，可使用 git checkout 命令。该命令用于在不同分支间切换、恢复文件或提交状态以及创建新分支，还能丢弃未暂存的更改，但不会删除新文件，仅删除修改标志。例如：
```bash
# 丢弃所有未暂存的更改：
git checkout .
# 丢弃自上次提交以来对文件的所有未暂存更改
git checkout <file>
```
git checkout -f 是 Git 中用于强制切换分支或者恢复文件到某个状态的命令。

- **切换分支**：当你想要切换到另一个分支，而当前分支上有未提交的更改时，执行 git checkout -f <branch> 会强制你切换到指定的 <branch>，并丢弃当前分支上的所有未保存的更改。也就是说，未提交的更改会被清除。

- **恢复文件**：如果你想要恢复某些文件到最后一次提交的状态，可以使用 git checkout -f <file>。这也会丢弃该文件在工作区中的更改，恢复为上次提交的状态。但是不会删除新文件。例如：
```bash
# 强制切换到分支 `feature-branch`
git checkout -f feature-branch
# 强制恢复文件 `example.txt` 到最后一次提交的状态
git checkout -f example.txt
```

### 8.本地仓库整理操作
本地仓库整理操作至关重要，原因在于本地仓库提交至远程仓库后无法直接撤回。一旦数据推送到远程仓库，便只能从远程仓库拉取数据到本地进行回退，再重新提交。这是由于远程仓库中的数据可能已被他人拉取并修改，若随意撤销，容易引发冲突和混乱。
### 整理上一次提交
对最近一次提交进行修改或优化：
  * **修改提交信息** ：使用命令 git commit --amend -m "新的提交信息"，可更改上一次提交时填写的提交信息，若复用提交记录，不带 -m 参数则会进入编辑器状态。
  * **添加遗漏的文件** ：先将遗漏文件添加到暂存区，再使用 --amend 将其合并到上一次提交中，命令依次为 git add 忘记的文件 和 git commit --amend。
  * **修改提交的内容** ：修改文件内容后执行 git commit --amend，可将更改合并到上一次提交中。

### 整理多次提交
整理多次提交的实现方式主要有：

  * **交互式变基（Interactive Rebase）** ：通过执行命令 git rebase -i HEAD~n，可以对最近的 n 次提交进行整理。在交互式模式下，可以选择对每个提交执行不同的操作，例如：

pick：保留该提交。
squash：将该提交与前一个提交合并。
edit：修改该提交。
reword：修改该提交的提交信息。
drop：丢弃该提交。

交互式变基语法为：
```bash
   # 修改 hash1 之后的提交信息（不包含 hash1）
    git rebase -i hash1
   # 修改 hash1 到 hash2 的提交信息（不包含 hash1）
    git rebase -i h1 h2
```
h1 指 hash1，h2 指 hash2，即 commit 版本号，这是一个左开右闭区间。若 git rebase -i 后不跟 hash 值，默认整理上一次 push 到远端版本到最近一个 commit 版本。

在修改提交时，只能使用 git commit --amend 和 git rebase --continue 命令，并进入 REBASE 状态。进入该状态后，修改文件并 git add 到暂存区，再用 git commit --amend 整理到本地仓库，整理完成用 git rebase --continue 继续，直至回到 master 分支。
  * **合并提交（Squash）** ：将多个小的、相关提交整合为一个更大提交，使历史记录简洁。
  * **重新排序提交** ：改变提交顺序，确保日志按逻辑顺序排列。
  * **修复提交** ：若多个提交中存在错误，通过整理提交修复历史记录。


### 五、结论
版本控制在现代软件开发中至关重要，而Git作为一种分布式版本控制系统，提供了高效、灵活的解决方案。它不仅支持多人协作开发，还通过强大的分支管理和高效的性能，极大地提升了开发效率和代码管理能力。在开源项目中，Git和GitHub等平台的应用更是为全球开发者提供了高效协作的工具，推动了开源社区的发展。理解并掌握Git的使用，是每个开发者必备的技能。



